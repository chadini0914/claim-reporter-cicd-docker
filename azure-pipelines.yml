

trigger:
- master

variables:
  vmImageName: 'ubuntu-latest'
  buildID: $(Build.BuildNumber)

stages:

- stage: Build
  displayName: try_build_docker

  jobs:
    - job: docker_try
      displayName: docker_try_build
      pool:
        vmImage: $(vmImageName)


      steps:
        - task: Docker@2
          displayName: try_Build
          inputs:
            command: build

- stage: Push
  displayName: push_build_docker
  condition: succeeded()

  jobs:
    - job: docker_buildpush
      displayName: build&push
      pool:
        vmImage: $(vmImageName)

      steps:
        - task: Docker@2
          displayName: Login to ACR
          inputs:
            command: login
            containerRegistry: acr   #service conntection 
        - task: Docker@2
          displayName: BuildandPush
          inputs:
            command: buildAndPush
            repository: buildImages
            tags: |
              $(buildID)


              #Your build pipeline references an undefined variable named ‘Parameters.ConnectedServiceName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#Your build pipeline references an undefined variable named ‘Parameters.WebAppKind’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#Your build pipeline references an undefined variable named ‘Parameters.WebAppName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#Your build pipeline references an undefined variable named ‘Parameters.DockerNamespace’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#Your build pipeline references an undefined variable named ‘Parameters.DockerRepository’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#Your build pipeline references an undefined variable named ‘Parameters.StartupCommand’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972

        - task: AzureRmWebAppDeployment@4
          displayName: 'Deploy Azure App Service'
          inputs:
            azureSubscription: '994d64b4-084a-4eef-ac28-3f1d1432feee'
            appType: 'webAppContainer'
            WebAppName: 'claim-reporter-cicd-docker'
            DockerNamespace: 'acrrdsnodev'
            DockerRepository: 'buildimages'
            DockerImageTag: '20210407.10'

